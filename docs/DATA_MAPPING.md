# Real Estate Deal Analyzer - Data Mapping

This document describes how data is mapped between different layers of the application (frontend, backend, and database) and any transformations that occur.

## System Overview

```
┌─────────────────┐         ┌──────────────────┐         ┌─────────────────┐
│    Frontend     │         │     Backend      │         │    Database     │
│    (React)      │ ───────>│  (Node/Express)  │ ───────>│   (MongoDB)     │
└─────────────────┘         └──────────────────┘         └─────────────────┘
```

## Data Flow Patterns

### 1. Frontend to Backend (Analysis Request)

When a user submits property data for analysis:

| Frontend Field | Backend Field | Transformation |
|----------------|---------------|----------------|
| `propertyType` | `propertyType` | None |
| `propertyName` | `propertyName` | None |
| `propertyAddress` | `propertyAddress` | None |
| `purchasePrice` | `purchasePrice` | None |
| `downPayment` | `downPayment` | None |
| `interestRate` | `interestRate` | None |
| `loanTerm` | `loanTerm` | None |
| `closingCosts` | `closingCosts` | Default to 0 if undefined |
| `repairCosts` | `repairCosts` | Default to 0 if undefined |
| `propertyTaxRate` | `propertyTaxRate` | None |
| `insuranceRate` | `insuranceRate` | None |
| `maintenanceCost` | `maintenanceCost` | None |
| `propertyManagementRate` | `propertyManagementRate` | None |
| `monthlyRent` (SFR) | `monthlyRent` | None |
| `squareFootage` (SFR) | `squareFootage` | None |
| `bedrooms` (SFR) | `bedrooms` | None |
| `bathrooms` (SFR) | `bathrooms` | None |
| `longTermAssumptions` | `longTermAssumptions` | Apply defaults for missing values |

### 2. Backend to Frontend (Analysis Response)

When the backend returns analysis results:

| Backend Field | Frontend Field | Transformation |
|---------------|----------------|----------------|
| `monthlyAnalysis` | `monthlyAnalysis` | Ensure all properties exist, normalize structure |
| `annualAnalysis` | `annualAnalysis` | Calculate from monthly if missing |
| `longTermAnalysis.projections` | `longTermAnalysis.projections` | Always recalculated for consistency |
| `longTermAnalysis.returns` | `longTermAnalysis.returns` | Recalculated based on projections |
| `longTermAnalysis.exitAnalysis` | `longTermAnalysis.exitAnalysis` | Recalculated based on projections |
| `keyMetrics` | `keyMetrics` | Ensure all metrics are present |
| `aiInsights` | `aiInsights` | Preserved as-is |

### 3. Frontend to Database (Save Property)

When saving a property:

| Frontend Field | Database Field | Transformation |
|----------------|----------------|----------------|
| All property data | Property document | Flattened into a single document |
| `analysis` | `analysis` embedded document | Full analysis is stored |
| (none) | `createdAt` | Added automatically |
| (none) | `updatedAt` | Added automatically |
| (none) | `_id` | Generated by MongoDB |

### 4. Database to Frontend (Load Property)

When loading a saved property:

| Database Field | Frontend Field | Transformation |
|----------------|----------------|----------------|
| Property document | Property form data | Restructured to match form structure |
| `analysis` | `analysis` | Normalized structure (see Adapter) |
| `createdAt` | Displayed in UI | Formatted date |
| `updatedAt` | Displayed in UI | Formatted date |
| `_id` | Used for updates | Preserved for API calls |

## Analysis Adapter Rules

The `analysisAdapter.ts` module handles data normalization between storage and UI:

```typescript
/**
 * adaptAnalysisForFrontend rules:
 * 1. Core property data is preserved
 * 2. Monthly analysis structure is normalized
 * 3. All projections are recalculated
 * 4. Exit analysis is recalculated
 * 5. Annual analysis is derived from monthly if missing
 * 6. AI Insights are preserved as-is
 */
```

### Key Transformations

1. **Monthly Analysis Normalization**:
   - Ensure all expense categories exist
   - Calculate totals if missing
   - Normalize mortgage object structure

2. **Yearly Projections Recalculation**:
   - Use consistent formulas for appreciation, income growth, and expense inflation
   - Ensure mortgage balance calculation is consistent
   - Recalculate equity based on property value and mortgage balance

3. **Metrics Calculation**:
   - Cap Rate: Ensure it's based on NOI and purchase price
   - Cash on Cash Return: Based on cash flow and total investment
   - DSCR: Based on NOI and debt service

## Data Validation

### Frontend Validation
- Form fields validated for required values and ranges
- Type checking with TypeScript interfaces
- UI prevents submission of invalid data

### Backend Validation
- Request body validated against schema
- Type conversion for numeric values
- Defaults applied for optional fields

## Example: Property Save/Load Flow

1. **User Saves a Property**:
   ```
   UI Form → Frontend State → API Request → Backend Controller → 
   Data Validation → Database Save → Response ID → UI Success Message
   ```

2. **User Loads a Property**:
   ```
   UI Request → Frontend API Call → Backend Controller → 
   Database Query → Adapter Processing → Frontend State → UI Form Population
   ```

## Backward Compatibility

To maintain backward compatibility when data structures change:

1. **Database Layer**:
   - New fields are optional
   - Default values provided for missing fields
   - Version field tracks schema version

2. **API Layer**:
   - Response adapters handle legacy formats
   - Required fields remain consistent
   - New fields added incrementally

3. **Frontend Layer**:
   - Component props handle missing data
   - Default values for visualization
   - Error boundaries catch rendering issues

## Future Data Mapping Considerations

### Multi-Family Data Mapping

For future Multi-Family implementation:

| SFR Field | MF Field | Transformation |
|-----------|----------|----------------|
| `monthlyRent` | Calculated from `unitTypes` | Sum of (unit count × monthly rent) for each unit type |
| `squareFootage` | `totalSqft` | None |
| (none) | `unitTypes` | Array of unit type objects |
| `maintenanceCost` | `maintenanceCostPerUnit` | Multiplied by unit count |
| (none) | `commonAreaUtilities` | New object with utility costs |

### AI Integration Data Mapping

For enhanced AI analysis:

| Analysis Data | AI Input | Transformation |
|---------------|----------|----------------|
| Key metrics | Formatted prompt | Values extracted and formatted for LLM consumption |
| Property details | Formatted prompt | Relevant details extracted |
| (none) | Location data | Added from external APIs based on address |
| AI Response | `aiInsights` | Parsed from structured JSON response | 